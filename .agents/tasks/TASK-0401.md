# TASK-0401: Flow A chunk-mode pacing parity (hot path safety)

Status: DONE  
Assigned: Agent A (Voice Runtime)  
Date: 2026-02-20 (America/New_York)

## Objective
Ensure `VOICE_TWILIO_CHUNK_MODE` can remain default ON without regressing startup clarity or pacing stability.

## Scope (exclusive)
- `features/voice_flow_a.py`
- `tests/test_voice_flow_a.py`

## Required behavior
- Chunk mode must honor startup prebuffer/start-buffer and refill-hysteresis guards.
- Chunk mode must maintain stable playout pacing equivalent to 20ms/frame cadence.
- Existing barge-in semantics must remain intact.

## Logging evidence required
- Review latest `ops/logs/vozlia-ng-*.log` after deployment.
- Confirm expected signatures during a test call:
  - `OPENAI_AUDIO_DELTA_FIRST`
  - `TWILIO_MAIN_FRAME_SENT first=1`
  - `twilio_send stats`
  - `BARGE-IN` / `BARGE-IN_IGNORED_EARLY` behavior unchanged except expected tuning.

## Checks
- `ruff check features/voice_flow_a.py tests/test_voice_flow_a.py`
- `python3 -m py_compile features/voice_flow_a.py tests/test_voice_flow_a.py`
- `.venv/bin/python -m pytest -q tests/test_voice_flow_a.py`

## Implementation notes (2026-02-20)
- Updated chunk-mode idle path in `features/voice_flow_a.py` to mirror frame-mode sender behavior for:
  - underrun vs idle accounting
  - idle clock normalization (`next_due`/`idle_late_ms_max`)
  - periodic `twilio_send stats` emission/reset while waiting for audio
- This keeps chunk mode on the same pacing-control path as frame mode during refill gaps without changing barge-in logic.
- Added guardrail tests in `tests/test_voice_flow_a.py`:
  - `_playout_start_frames` clamping
  - `_playout_low_water_frames` default/clamping
  - `_playout_refill_hold_s` conversion/clamping

## Evidence (logs + checks)
- Latest Render logs reviewed:
  - `ops/logs/vozlia-ng-20260220T195003Z-10.log`
  - `ops/logs/vozlia-ng-20260220T194253Z-9.log`
  - `ops/logs/vozlia-ng-20260220T192823Z-8.log`
- In those latest three files, target voice signatures were not present (no qualifying test-call traces in those captures).
- Most recent files containing expected signatures:
  - `ops/logs/vozlia-ng-20260220T181422Z-4.log`
  - `ops/logs/vozlia-ng-20260220T174654Z-2.log`
- Verified there:
  - `OPENAI_AUDIO_DELTA_FIRST`
  - `BARGE-IN` and `BARGE-IN_IGNORED_EARLY`
- Local required checks run and passed:
  - `ruff check features/voice_flow_a.py tests/test_voice_flow_a.py`
  - `python3 -m py_compile features/voice_flow_a.py tests/test_voice_flow_a.py`
  - `.venv/bin/python -m pytest -q tests/test_voice_flow_a.py` (41 passed)
