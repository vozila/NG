# TASK-0402: Render log tooling hardening + operator workflow docs

Status: DONE  
Assigned: Agent B (Ops Tooling)  
Date: 2026-02-20 (America/New_York)

## Objective
Harden local Render log capture/analyzer workflow so troubleshooting is deterministic and repeatable.

## Scope (exclusive)
- `scripts/capture_render_logs.sh`
- `scripts/analyze_bargein_latency.py`
- `scripts/extract_call_window.py`
- `ops/REFERENCE_PACKS/voice_flow_a.md`

## Required behavior
- Keep automatic capture, rotation, and retry behavior.
- Ensure analysis scripts produce stable output for:
  - accepted barge-ins
  - ignored-early barge-ins
  - per-call extraction.
- Keep credentials out of logs by process discipline (`umask`, no env dump).

## Logging evidence required
- Validate on real files in `ops/logs/`.
- Include one sample command output in `ops/JOURNAL.md` (no secrets).

## Checks
- `bash -n scripts/capture_render_logs.sh`
- `python3 -m py_compile scripts/analyze_bargein_latency.py scripts/extract_call_window.py`
- `ruff check scripts/analyze_bargein_latency.py scripts/extract_call_window.py`

## Implementation notes (B001)
- Hardened capture process discipline in `scripts/capture_render_logs.sh`:
  - Added `umask 077` to keep captured logs private by default.
  - Redacted operator-visible stream command banner (`command=<redacted>`).
  - Added sanitization for captured lines (`Bearer ...` and token/api-key query params).
- Added deterministic file selection controls in tooling:
  - `scripts/analyze_bargein_latency.py`: new `--sort-by {name,mtime}` and `FILES ...` output line.
  - `scripts/extract_call_window.py`: new `--sort-by {name,mtime}` and `--last-files`.
- Updated deterministic runbook command shapes in:
  - `ops/REFERENCE_PACKS/voice_flow_a.md`

## Log review evidence (ops/logs)
- Latest rotated files reviewed (`vozlia-ng-20260220T191208Z-6.log` through `vozlia-ng-20260220T195003Z-10.log`) show repeated Render API failures:
  - `capture_render_logs: render query failed; retrying without advancing cursor ...`
  - `Error: error listing logs: received response code 500: internal server error`
- Earlier files in the same sequence contain expected call/barge-in markers (`TWILIO_WS_START`, `OpenAI VAD: user speech START`, `TWILIO_CLEAR_SENT`, `BARGE-IN_IGNORED_EARLY`, `OPENAI_RESPONSE_DONE`), validating parser coverage.

## Evidence command outputs (no secrets)
Command:
`python3 scripts/analyze_bargein_latency.py --glob 'ops/logs/vozlia-ng-*.log' --sort-by mtime --last-files 12`

Output excerpt:
`files=11 sort_by=mtime events=12`
`SUMMARY ignored_early_count=5`
`SUMMARY accepted_clear_ms count=7 min=0 p50=0 p90=0 max=0 mean=0.0 median=0`
`SUMMARY accepted_done_ms count=7 min=16 p50=20 p90=24 max=24 mean=20.3 median=20`

Command:
`python3 scripts/analyze_bargein_latency.py --glob 'ops/logs/vozlia-ng-*.log' --sort-by mtime --last-files 0 --rid CAc831a7d96e916c63500593e0976af84a`

Output excerpt:
`files=11 sort_by=mtime events=6`
`SUMMARY ignored_early_count=2`
`SUMMARY accepted_done_ms count=4 min=19 p50=20 p90=24 max=24 mean=20.5 median=19.5`

Command:
`python3 scripts/extract_call_window.py --glob 'ops/logs/vozlia-ng-*.log' --sort-by mtime --last-files 0 --rid CAc831a7d96e916c63500593e0976af84a --out ops/logs/extract-CAc831a7d96e916c63500593e0976af84a-b001.log`

Output excerpt:
`Wrote 545 lines to ops/logs/extract-CAc831a7d96e916c63500593e0976af84a-b001.log (files=11 sort_by=mtime last_files=0)`
`Markers: ws_start=1 ws_stop=0`
