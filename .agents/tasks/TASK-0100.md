# TASK-0100: Voice Flow A - Twilio WS skeleton + waiting-audio hooks (Slice A+B)

Status: NOT STARTED   
Owner: Codex Agent (Voice)

Feature flag: `VOZ_FEATURE_VOICE_FLOW_A` (default OFF)

## Goal
Implement the NG Voice Flow A websocket endpoint `/twilio/stream` in a single feature module and lay the foundation for “thinking chime” (waiting audio) without fighting barge-in/buffers later.

This is **only Slice A+B**: event parsing + minimal WS loop + waiting-audio state hooks.  
**Out of scope**: OpenAI Realtime connection, audio pacing/buffering, barge-in cancel, skills/tools.

## Constraints (non-negotiable)
- Only modify: `features/voice_flow_a.py` (and optionally `tests/test_voice_flow_a.py`  if needed).
- No cross-feature imports. Only stdlib + `core/*` + FastAPI/Pydantic.
- Debug logs must be gated behind `VOZLIA_DEBUG=1` only.
- Hot path discipline: no DB, no LLM, no network calls.
`
## Legacy references (read-only)
Legacy reference (read only):
- `vozlia-backend/api/routers/twilio.py` (WS mount)
- `vozlia-backend/vozlia_twilio/stream.py` (Twilio event loop patterns)

---

## Deliverables

### 1) Web Socket endpoint
- Route: WS `/twilio/stream`.
- Parses Twilio Media Streams events: `connected`, `start`, `media`, `stop`.
- Minimal state: `streamSid`, `callSid`, `from_number`, `tenant_id` (from start.customParameters allowlist keys only).
 - For `media` events: base64-decode payload to bytes and discard (for now). No buffering.

### 2) Pure parser helpers (offline tests)
Implement pure functions:
- `parse_twilio_start(d: dict) -> dict` (extract streamSid, callSid, from_number, tenant_id)
- `parse_twilio_media(d: dict) -> bytes | None` (decode base64 payload safely)
- `is_twilio_stop(d: dict) -> bool`


### 3) Waiting-audio foundation (no chime audio yet)
Add state hooks to make the future chime implementable without fighting buffers/barge-in.
- State vars: `waiting_audio_active: bool`, `waiting_started_ms: int | None`
- Stubs: `notify_wait_start(reason: str) -> None`, `notify_wait_end() -> None`
- Threshold: `VOICE_WAIT_SOUND_TRIGGER_MS` default 800ms
- No real chime output yet; only state transitions + debug-gated breadcrumbs.

### 4) FEATURE contract
Export `FEATURE` with required keys, and `enabled_env` **must** be exactly `"VOZ_FEATURE_VOICE_FLOW_A"`.

## selftests()
Must be deterministic (no network / DB).
- Validate parsers on sample events (include malformed inputs).
 - Verify route mounting: flag OFF -> not mounted, flag ON -> present.

Return `{ok: bool, message: str}`.

## security_checks()
- Assert default OFF unless env truthy.
- Assert tenant_id extraction only from allowlisted keys and stripped.
`
## load_profile()
Stub: `return {"hint": "ws-parse", "p50_ms": 10, "p95_ms": 50}`

---

## Acceptance (MUST PASS)

Run from repo root:

```bash
python -m compileall core features scripts main.py
python -m ruff check core features scripts tests main.py
pytest -q
VOZ_FEATURE_ADMIN_QUALITY=1 VOZ_FEATURE_SAMPLE=0 VOZ_FEATURE_VOICE_FLOW_A=0 python scripts/run_regression.py
```

Rollback: set `VOZ_FEATURE_VOICE_FLOW_A=0` and restart app.
