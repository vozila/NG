# TASK-0203: Shared line dual-mode access codes (client vs owner) + Stream actor_mode propagation

Status: NOT STARTED  
Owner: Codex Agent (Access)  
Feature flag: `VOZ_FEATURE_SHARED_LINE_ACCESS` (already exists; must remain the gate)

## Goal
Update shared-line access so that the **8-digit access code determines the AI mode**:
- `actor_mode=client` for customer-facing behavior
- `actor_mode=owner` for business-owner-facing behavior

This task updates TwiML + Stream params so Flow A can apply mode-specific protocols.

## Definition of Ready (DoR)
- Objective: access code resolves `{tenant_id, actor_mode}` and is passed into Twilio Stream `start.customParameters`.
- Acceptance: unit/selftest proof + expected log signatures + rollback path defined.
- Constraints: one-file feature module discipline (no cross-feature imports).
- Reference Pack: none exists yet -> MUST create `ops/REFERENCE_PACKS/shared_line_access.md` FIRST (Reference-first gate).
- Rollback point: keep legacy behavior by not setting new env vars (client map/table), and/or flip `VOZ_FEATURE_SHARED_LINE_ACCESS=0` (hard stop).

## Non-negotiable constraints
- Do NOT touch any files outside the allowed list.
- No cross-feature imports.
- Debug logs must be gated behind `VOZLIA_DEBUG=1` only.
- Keep TwiML XML escaping correct (especially query string `&amp;` escaping).

## Required behavior changes

### A) Prompt wording (shared line Gather)
Change shared-line prompt from:
- "Please enter your 8 digit business access code."
to:
- "Please enter your 8 digit access code."

Optional (nice): allow override via env `VOZ_ACCESS_CODE_PROMPT` (string). Default remains the generic prompt above.

### B) Access-code -> tenant + actor_mode resolution (shared line)
Add support for EITHER:

#### Option 1 (preferred unified table):
`VOZ_ACCESS_CODE_TABLE_JSON` (JSON object):
```json
{
  "12345678": {"tenant_id":"tenant_demo","actor_mode":"owner"},
  "87654321": {"tenant_id":"tenant_demo","actor_mode":"client"}
}
```

Validation rules:
- keys: exactly 8 digits (string)
- values: object with non-empty tenant_id and actor_mode in {"client","owner"}

Option 2 (back-compat merge):

Existing: `VOZ_ACCESS_CODE_MAP_JSON` = OWNER codes map `{code: tenant_id}`

New: `VOZ_CLIENT_ACCESS_CODE_MAP_JSON` = CLIENT codes map `{code: tenant_id}`

Resolution precedence:
- If table JSON exists and validates, use it.
- Else if code in client map -> actor_mode="client"
- Else if code in owner map (`VOZ_ACCESS_CODE_MAP_JSON`) -> actor_mode="owner"
- Else invalid

Back-compat guarantee:
- If only `VOZ_ACCESS_CODE_MAP_JSON` is set, behavior remains owner-only (but prompt is now generic).

### C) Stream parameters

When building `<Connect><Stream>`, include:
- `<Parameter name="actor_mode" value="client|owner"/>`

Also for dedicated line routing, include:
- `actor_mode="client"` (safe default).

### D) Logging (debug-only)
Add/extend debug breadcrumbs:
- On access grant: `access granted: tenant_id=... actor_mode=...`
- On routing decision (shared): include `actor_mode` when known

### E) Selftests (required)
Update `selftests()` in `features/shared_line_access.py` to include:
- Shared line returns Gather and action URL has `&amp;`
- Valid OWNER code returns `<Connect><Stream ...>` and includes tenant_id and actor_mode=owner
- Valid CLIENT code returns `<Connect><Stream ...>` and includes tenant_id and actor_mode=client
- Invalid code retries and eventually hangs up (existing behavior)

Selftests must not require external services.

Acceptance tests (local)

Run all of:
- `python -m compileall .`
- `python -c "import features.shared_line_access"`
- `ruff check .`
- `pytest -q`
- `VOZ_FEATURE_ADMIN_QUALITY=1 VOZ_FEATURE_SHARED_LINE_ACCESS=1 python scripts/run_regression.py`

Rollback plan

Soft rollback (mode behavior): unset `VOZ_ACCESS_CODE_TABLE_JSON` and `VOZ_CLIENT_ACCESS_CODE_MAP_JSON` so all valid codes resolve to owner (legacy semantics).

Hard rollback: `VOZ_FEATURE_SHARED_LINE_ACCESS=0`.

Memory spine writeback (IMPORTANT)

To avoid file conflicts with Agent B:
- ONLY update/create: `ops/REFERENCE_PACKS/shared_line_access.md`
- Do NOT touch `ops/JOURNAL.md` or `ops/CHECKPOINT.md` in this task.

Deliverables
- Updated `features/shared_line_access.py`
- New `ops/REFERENCE_PACKS/shared_line_access.md` documenting:
  - endpoints
  - env vars
  - mode resolution rules
  - failure signatures
  - rollback levers
