# TASK-0203: Shared line dual-mode access codes (customer vs owner) + Stream ai_mode propagation

Status: DONE  
Completed: 2026-02-18 (America/New_York)  
Owner: Codex Agent (Access)  
Feature gate: `VOZ_FEATURE_SHARED_LINE_ACCESS=1`  
Rollback: set `VOZ_DUAL_MODE_ACCESS=0` (reverts to legacy owner-only access code behavior)

## Goal
Make the **8-digit access code** determine **AI mode** for a tenant:

- `ai_mode=customer` → customer-facing behavior/protocols  
- `ai_mode=owner` → business-owner-facing behavior/protocols  

This task ensures the selected `ai_mode` is propagated into Flow A via Twilio Stream `start.customParameters.ai_mode`.

## What shipped (final behavior)
### 1) Prompt neutrality
Shared-line prompt is generic and not “owner-biased”.

- Default prompt: “Please enter your 8-digit access code.”
- Optional override: `VOZ_ACCESS_CODE_PROMPT="..."`

### 2) Access code resolution
Resolver returns `{tenant_id, ai_mode}`.

Config options (MVP env-only):

- Kill switch:
  - `VOZ_DUAL_MODE_ACCESS=0|1` (default OFF in principle; enable only when validated)
- Preferred mapping (when dual-mode enabled):
  - `VOZ_ACCESS_CODE_ROUTING_JSON='{"12345678":{"tenant_id":"tenant_demo","ai_mode":"owner"},"87654321":{"tenant_id":"tenant_demo","ai_mode":"customer"}}'`
- Back-compat fallbacks (when dual-mode enabled but routing JSON is absent):
  - `VOZ_CLIENT_ACCESS_CODE_MAP_JSON='{"87654321":"tenant_demo"}'`  → `ai_mode=customer`
  - `VOZ_ACCESS_CODE_MAP_JSON='{"12345678":"tenant_demo"}'`         → `ai_mode=owner`
- Legacy behavior (when dual-mode disabled):
  - `VOZ_ACCESS_CODE_MAP_JSON` is treated as **owner-only** and returns `ai_mode=owner`

### 3) Stream propagation (required)
On successful code entry, the generated TwiML `<Connect><Stream>` includes:

- `tenant_id`
- `tenant_mode`
- `rid`
- `ai_mode`  ✅

Flow A reads `start.customParameters.ai_mode`.

### 4) Dedicated-line behavior (explicit)
If a dedicated line routes immediately, it sets:
- `ai_mode=customer` (default)

## Acceptance tests
### A) Feature selftests (Regression Agent)
- `features/shared_line_access.py:selftests()` validates:
  - shared line returns `<Gather ... action="...&amp;attempt=0&amp;rid=...">` (XML-safe escaping)
  - access-code endpoint accepts both codes (customer + owner) in dual-mode
  - TwiML includes `ai_mode` parameter for Stream

### B) Manual smoke
1. Call shared number
2. Enter customer code → expect Flow A logs show `ai_mode=customer`
3. Enter owner code → expect Flow A logs show `ai_mode=owner`

## Notes / invariants
- Mode label is **`ai_mode`** with allowed values `{customer, owner}`.
- Do not introduce `client` naming into the Twilio Stream contract; Flow A maps for back-compat internally.

