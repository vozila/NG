# TASK-0213: Post-call extraction feature (summary + lead + appointment request)

Status: DONE  
Assigned: Codex Agent A  
Date: 2026-02-19 (America/New_York)

## Scope
- Add out-of-band extraction feature module:
  - `features/postcall_extract.py`
- Add tests:
  - `tests/test_postcall_extract.py`
- Add reference pack:
  - `ops/REFERENCE_PACKS/postcall_extract.md`

## Objective
For a given `(tenant_id, rid)` call, read transcript events from the event store, produce strict schema-validated JSON outputs, and write structured events:
- `postcall.summary`
- `postcall.lead`
- `postcall.appt_request` (when requested)

## Endpoint
- `POST /admin/postcall/extract`
- Body:
  - `tenant_id: str`
  - `rid: str`
  - `ai_mode: customer|owner`
  - `idempotency_key: str`
- Auth:
  - Bearer token with `VOZ_ADMIN_API_KEY`

## Required kill switches
- `VOZ_FEATURE_POSTCALL_EXTRACT=0|1` (feature gate, default off)
- `VOZ_POSTCALL_EXTRACT_ENABLED=0|1` (runtime gate, default off)

## Behavioral constraints
- No Flow A changes.
- Deterministic execution shape:
  - proposer returns JSON (model-first; heuristic fallback if model unavailable/fails)
  - Pydantic validates JSON strictly
  - Python writes events
- Fail closed:
  - invalid schema => write `postcall.extract_failed` + reason, return HTTP 422
- Idempotent:
  - same `(tenant_id, rid, idempotency_key)` must not duplicate outputs
- Tenant isolation:
  - only read/query within provided tenant_id

## Runtime knobs
- `VOZ_POSTCALL_EXTRACT_MODEL_ENABLED=0|1` (default `1`)
- `VOZ_POSTCALL_EXTRACT_MODEL=<model_name>` (default `gpt-4o-mini`)
- `OPENAI_API_KEY` required for model path
- Debug breadcrumbs (when `VOZLIA_DEBUG=1`):
  - `POSTCALL_EXTRACT_MODEL_USED ...`
  - `POSTCALL_EXTRACT_FALLBACK_USED ...`

## Acceptance criteria
- After seeding transcript events, `/admin/postcall/extract` writes 2â€“3 structured postcall events.
- Tests cover:
  - schema validation failure path
  - idempotency behavior
  - tenant isolation
