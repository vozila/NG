# Vozlia NG — Agent Roster & Operating Rules

**North Star:** Build Vozlia NG as a modular monolith with auto-discovered, feature-flagged, one-file feature modules.
This repo is intentionally designed to scale to **many parallel Codex agents** without regressions.

---

## 0) Roles (who can touch what)

### Core Maintainer (limited group)
**May change:**
- `core/*`
- `core/feature_loader.py`
- repo-wide build config (`pyproject.toml`, CI workflows)

**Owns:**
- DB/event-store primitives
- tenant isolation primitives
- auth primitives
- shared ports/interfaces

### Feature Agents (most agents)
**May change:**
- `features/*` (one feature = one primary file)
- may add new feature files
- may add feature-specific tests in `tests/`

**May NOT:**
- import across features
- change core surface area (unless Core Maintainer explicitly assigns)

### WebUI Agents
**May change:**
- `webui/*` (future directory; Next.js/React)
- API clients/types shared with backend via generated schemas

### Control Plane Agents
**May change:**
- `control_plane/*` (future directory; provisioning, tenant admin, billing orchestration)
- may call into backend via explicit ports/APIs (no hidden DB coupling)

---

## 1) One-task discipline (mandatory)

- **One agent = one task = one branch**
- Specs live in: `.agents/tasks/TASK-XXXX.md`
- If a task touches more than ~3 files, it must include a refactor justification + rollback plan.

---

## 2) Non-negotiable invariants

### 2.1 One-file feature modules (plugin-style)
- Each new feature lives primarily in **one file**: `features/<feature_key>.py`
- Feature modules self-register via `FEATURE = {...}` and are auto-discovered.
- No manual wiring in `main.py` or `core/app.py`.

### 2.2 Hot-path discipline (Flow A)
Flow A is sacred:
**Twilio → FastAPI WS `/twilio/stream` → OpenAI Realtime → Twilio**

Rules:
- No heavy planning inside the WS loop
- No unbounded DB reads/writes inside the WS loop
- Deterministic, bounded work only (queue, counters, routing)

### 2.3 “LLM plans; Python executes deterministically”
- Any LLM output that triggers an action must be:
  1) strict JSON
  2) schema-validated (Pydantic)
  3) executed deterministically in Python

### 2.4 Feature flags
Every new feature must have a kill-switch:
- `VOZ_FEATURE_<NAME>` (default **OFF**)

All debug logs must be gated by:
- `VOZLIA_DEBUG=1` (default **OFF**)

---

## 3) Thinking chime requirement (Flow A)

**Problem:** users experience silence while the system is “thinking” or executing skills.

**Invariant:**
- A “thinking chime” (short, unobtrusive tone) MUST be possible without causing regressions in:
  - barge-in
  - Twilio buffering / clear events
  - OpenAI Realtime audio output pacing

**Implementation rule:**
- Chime is **deterministic audio** injected by the server (not generated by the LLM).
- Chime must be:
  - env-flagged OFF by default
  - stopped immediately on barge-in or when assistant audio begins

---

## 4) Repo continuity requirement (mandatory)

In addition to chat checkpoints, the repo must contain an append-only log of major decisions and findings:

- `ops/JOURNAL.md` is the **canonical running log**
- After any meaningful session/task, append:
  - decisions
  - invariants discovered
  - constraints / edge cases
  - next actions
  - (≤5) evidence log lines if applicable

This log is used to bring new agents/sessions up to speed fast.

---

## 5) Quality gates (must be runnable locally + CI)

Minimum commands for backend:
- `python -m compileall .`
- `ruff check .`
- `pytest -q`

Regression Agent:
- `/admin/quality/regression/run` (when feature enabled)
- writes machine-readable report under `ops/QUALITY_REPORTS/`

---

## 6) Active assignments

- (none — create tasks under `.agents/tasks/`)

